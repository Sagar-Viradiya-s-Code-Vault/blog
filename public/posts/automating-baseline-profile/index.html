<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Automating Baseline Profile end-to-end on CI | Sagar's Blog</title>
<meta name=keywords content="Performance,BaselineProfile,Gradle"><meta name=description content="Baseline profile CI automation"><meta name=author content><link rel=canonical href=https://sagarviradiya.dev/posts/automating-baseline-profile/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.0ca7eb5c58d462c1500c10b5503144143e6a21142fc22557ae94a8112158af8d.css integrity="sha256-DKfrXFjUYsFQDBC1UDFEFD5qIRQvwiVXrpSoESFYr40=" rel="preload stylesheet" as=style><link rel=icon href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Automating Baseline Profile end-to-end on CI"><meta property="og:description" content="Baseline profile CI automation"><meta property="og:type" content="article"><meta property="og:url" content="https://sagarviradiya.dev/posts/automating-baseline-profile/"><meta property="og:image" content="https://sagarviradiya.dev/images/header.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-16T00:00:00+00:00"><meta property="og:site_name" content="Sagar's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sagarviradiya.dev/images/header.jpeg"><meta name=twitter:title content="Automating Baseline Profile end-to-end on CI"><meta name=twitter:description content="Baseline profile CI automation"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sagarviradiya.dev/posts/"},{"@type":"ListItem","position":2,"name":"Automating Baseline Profile end-to-end on CI","item":"https://sagarviradiya.dev/posts/automating-baseline-profile/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Automating Baseline Profile end-to-end on CI","name":"Automating Baseline Profile end-to-end on CI","description":"Baseline profile CI automation","keywords":["Performance","BaselineProfile","Gradle"],"articleBody":"Baseline profile allows you to pre-package a list of classes and methods with APK that are required during launch or in the critical user journey (Core flow of your app). Before the baseline profile, this list either had to be generated on the device by analyzing a few app launches or sourced from Play Store if other devices already figured out this list and uploaded it to Play Store. This list of classes and methods is then pre-compiled to machine code so that during app launch and critical user journey this code is ready to execute by CPU thereby making the entire flow faster.\nFurther reading of this blog requires context on the baseline profile and unfortunately, this is out of the scope for this blog. To start with I would recommend this talk from the Android Dev Summit to get some context on the baseline profile and then continue here.\nThe problem at hand Through this blog, I want to stress upon automation part of the baseline profile. As you make changes in the code you need to update the profile so that it can include new classes and methods required either during launch or during critical user journey.\nKeeping the profile up to date is only half of the problem. You need to make sure the profile is working as expected. For that, you need to run macro-benchmark tests to verify profile is reducing launch time.\nWe will explore possible solutions to the above problems, so let’s get started without further ado!\nAutomating profile generation With baseline profile gradle plugin you can easily update profile as this plugin does the heavy lifting of building the required test APKs, running tests on the device, and copying the generated profile to the correct directory after test completes. Due to scope of this blog I won’t go into details about plugin setup. You would need a test module setup and plugin setup within the test module.\nAssuming your plugin setup is correct, the CI setup is fairly simple. We will focus on GitHub action as our CI platform. Converting setup for other CI platforms shouldn’t be difficult. Here is the workflow that will update the profile on every pull request. After a successful run, the workflow should update PR with the modified profile.\nname: Generate Baseline Profile on: pull_request jobs: build-benchmark-apks: name: Generate baseline profile runs-on: macos-latest timeout-minutes: 20 steps: - name: Checkout uses: actions/checkout@v3 - name: Validate Gradle Wrapper uses: gradle/wrapper-validation-action@v1 - name: Set up JDK 17 uses: actions/setup-java@v3 with: distribution: 'zulu' java-version: 17 - name: Install GMD image for baseline profile generation run: yes | \"$ANDROID_HOME\"/cmdline-tools/latest/bin/sdkmanager \"system-images;android-33;aosp_atd;x86_64\" - name: Accept Android licenses run: yes | \"$ANDROID_HOME\"/cmdline-tools/latest/bin/sdkmanager --licenses || true - name: Generate profile run: ./gradlew :sample:generateBaselineProfile -Pandroid.testoptions.manageddevices.emulator.gpu=\"swiftshader_indirect\" You can configure the baseline profile gradle plugin to generate profile through gradle managed device. The above workflow first installs a system image for gradle managed device. Then it accepts the license for the installed system image. Finally, it runs the generation part by executing ./gradlew :sample:generateBaselineProfile command. Note android.testoptions.manageddevices.emulator.gpu test parameter we are passing. This is required to run gradle manged device on GitHub action running on macOS. Without this profile generation will fail throwing device setup error.\nIf you can not use baseline profile gradle plugin for some reason (required AGP 8.0 and above) then this can be tricky as there would be an additional step required to pull the profile from the device and store it in the source directory. Chris Banes wrote a workflow for this that you can use as a reference.\nAutomating profile verification When it comes to automating the verification of the profile, things are a little tricky. Profile verification requires running macro-benchmark tests on physical devices. This means you need to spin up a physical device to run verification and fetch benchmark results from the device. For the scope of this blog, we will focus on the Firebase test lab.\nRunning instrumented tests on the Firebase test lab is not challenging at all. Many of you are already doing this with your instrumented test setup on CI. Since macro benchmark tests are instrumented tests only, this should be fairly simple. What’s challenging though is to download benchmark JSON from the device and parse it on CI to analyze the result.\nWhile contributing baseline profile CI setup on COIL (Image loading library) I came across the same challenge. I explored all possible solutions to automate the verification part and ultimately decided to write a Gradle plugin for this.\nAuto-Benchmark (Sorry for the shameless plug 😅) is a gradle plugin to automate this step as this is a bit complicated and not straightforward. The only limitation here is this plugin only supports Firebase Test Lab (FTL). It uploads benchmark APK and App APK to FTL and once tests are complete it downloads the result JSON. This JSON is then parsed and analyzed to determine the impact of the profile. The impact here is the percentage of improvement between no compilation median startup and baseline profile median startup time. Let’s see how you can utilize this plugin.\nFollowing is the plugin configuration you need in your app-level build.gradle file.\nautoBenchmark { // A relative file path from the root to app apk with baseline profile appApkFilePath.set(\"/sample/build/outputs/apk/benchmark/sample-benchmark.apk\") // A relative file path from the root to benchmark apk benchmarkApkFilePath.set(\"/benchmark/build/outputs/apk/benchmark/benchmark-benchmark.apk\") // A relative file path of service account JSON to authenticate Firebase Test Lab serviceAccountJsonFilePath.set(\"../../.config/gcloud/application_default_credentials.json\") // Physical device configuration map to run benchmark physicalDevices.set(mapOf( \"model\" to \"redfin\", \"version\" to \"30\" )) // Tolerance percentage for improvement below which verification will fail tolerancePercentage.set(10f) } It takes three file paths. Two of them are relative paths to benchmark and app APKs. To authenticate Firebase Test Lab it requires your service account JSON file path. Next, it takes the device configuration on which you want to run your benchmark. In the above configuration, it uses Pixel 5 and API level 30. Lastly, It takes the tolerancePercentage. It is the percentage of improvement below which you want to fail your profile verification. So for example, if no compilation median startup is 233 ms and baseline profile median startup is 206 ms then startup time is improved by ~11%. If the provided tolerance percentage is 10 then the task will successfully complete.\nTo seed the tolerance percentage I would suggest running the benchmark on the initial profile locally many times (preferably more than 5 times) and taking the minimum percentage improvement between no compilation median startup and baseline profile median startup time.\nSeeding tolerance percentage like this is something I came up with. I know this is controversial as some of you might find this not a proper way to decide the baseline on your improvement. I would love to know your thoughts in case you have better suggestions on seeding tolerance percentage.\nWith the above simple configuration, it is just a matter of issuing one gradle command ./gradlew :app:runBenchmarkAndVerifyProfile to verify profile. For a detailed setup of this plugin, I would suggest checking the README guide.\nNow that we have seen how plugin works let’s see how you can integrate the plugin in CI pipeline. Once again we will see how you can set up this on GitHub action but it should be simple to migrate this on your choice of CI.\nIn the above configuration, we saw we need a service account JSON file path. We need to set up that first before we run profile verification on CI. For that first store base64 encoded service account JSON file as the GitHub environment variable. Then later in the workflow, we will decode this file and put it at the root level of the CI machine file system. To encode service account JSON run the following command.\nbase64 -i “$HOME/.config/gcloud/application_default_credentials.json” | pbcopy Paste the encoded JSON file to the GitHub environment variable GCLOUD_KEY. To decode this and restore it in the file system of the CI machine, run the following bash commands as a workflow step.\nGCLOUD_DIR=\"$HOME/.config/gcloud/\" mkdir -p \"$GCLOUD_DIR\" echo \"${{ vars.GCLOUD_KEY }}\" | base64 --decode \u003e \"$GCLOUD_DIR/application_default_credentials.json\" The above commands decode the encoded service account JSON file from the GitHub environment variable at $HOME/.config/gcloud/application_default_credentails.json\nNow let’s see the entire workflow.\nname: Verify Baseline Profile on: pull_request: branches: - release jobs: build-benchmark-apks: name: Build APKs and Run profile verification runs-on: macos-latest timeout-minutes: 20 steps: - name: Checkout uses: actions/checkout@v3 - name: Validate Gradle Wrapper uses: gradle/wrapper-validation-action@v1 - name: Set up JDK 17 uses: actions/setup-java@v3 with: distribution: 'zulu' java-version: 17 - name: Build benchmark apk run: ./gradlew :benchmark:assembleBenchmark - name: Build app apk run: ./gradlew :sample:assembleBenchmark - name: Set up authentication run: | GCLOUD_DIR=\"$HOME/.config/gcloud/\" mkdir -p \"$GCLOUD_DIR\" echo \"${{ vars.GCLOUD_KEY }}\" | base64 --decode \u003e \"$GCLOUD_DIR/application_default_credentials.json\" - name: Verify baseline profile run: ./gradlew :sample:runBenchmarkAndVerifyProfile In the above workflow, Set up authentication step is exactly doing what we saw above to restore the service account JSON file on the CI machine for the GitHub environment variable. After setting up credentials it runs the gradle command from plugin to verify profile. This is all you need to detect regression in your baseline profile setup. You can check both workflows we saw in my repo for reference. One important thing that I want to highlight here is, this plugin is only to detect the performance dip below tolerance percentage and to fail fast on CI. You can go further and collect these benchmark run results to visualise on a dashboard. Monitoring macro-benchmark results on a dashboard would give you more insights into app performance over time. You can refer to this performance sample repo guide to know how it can be done through GCloud Monitoring. Also, Py ⚔published a script that Square uses to compare two benchmark runs. Perhaps these are good starting points to build a dashboard around your macro-benchmark runs.\nI hope this guide will help you to automate baseline profile on CI. I would appreciate your feedback on the plugin so please do try it out and let me know what can be improved.\nUntil next time! ☮️ ✌️\nThanks to Shreyas Patil \u0026 Ben Weiss for proofreading this.\nThis was originally posted on Google Developer Expert Medium publication\n","wordCount":"1696","inLanguage":"en","image":"https://sagarviradiya.dev/images/header.jpeg","datePublished":"2024-01-16T00:00:00Z","dateModified":"2024-01-16T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://sagarviradiya.dev/posts/automating-baseline-profile/"},"publisher":{"@type":"Organization","name":"Sagar's Blog","logo":{"@type":"ImageObject","url":"https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sagarviradiya.dev/ accesskey=h title="Sagar Viradiya (Alt + H)"><img src=https://sagarviradiya.dev/apple-touch-icon.png alt aria-label=logo height=35>Sagar Viradiya</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sagarviradiya.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://sagarviradiya.dev/talks/ title=Talks><span>Talks</span></a></li><li><a href=https://sagarviradiya.dev/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://sagarviradiya.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sagarviradiya.dev/>Home</a>&nbsp;»&nbsp;<a href=https://sagarviradiya.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Automating Baseline Profile end-to-end on CI</h1><div class=post-meta><span title='2024-01-16 00:00:00 +0000 UTC'>January 16, 2024</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1696 words</div></header><figure class=entry-cover><a href=https://sagarviradiya.dev/posts/automating-baseline-profile/images/header.jpeg target=_blank rel="noopener noreferrer"><img loading=eager srcset="https://sagarviradiya.dev/posts/automating-baseline-profile/images/header_hu504580e4e0594bf3f7bf7b76af994632_267510_360x0_resize_q75_box.jpeg 360w ,https://sagarviradiya.dev/posts/automating-baseline-profile/images/header_hu504580e4e0594bf3f7bf7b76af994632_267510_480x0_resize_q75_box.jpeg 480w ,https://sagarviradiya.dev/posts/automating-baseline-profile/images/header_hu504580e4e0594bf3f7bf7b76af994632_267510_720x0_resize_q75_box.jpeg 720w ,https://sagarviradiya.dev/posts/automating-baseline-profile/images/header.jpeg 1024w" sizes="(min-width: 768px) 720px, 100vw" src=https://sagarviradiya.dev/posts/automating-baseline-profile/images/header.jpeg alt="[Generated With AI](https://www.bing.com/images/create/code-cherry-pick-automation/1-65912e832c0a4e258deb4823f36e3831?id=jXFueAidvsqN5z6werFzpA%3D%3D&amp;view=detailv2&amp;idpp=genimg) on [Bing](https://www.bing.com/images/create?FORM=GENILP)" width=1024 height=1024></a><p><a href="https://www.bing.com/images/create/code-cherry-pick-automation/1-65912e832c0a4e258deb4823f36e3831?id=jXFueAidvsqN5z6werFzpA%3D%3D&amp;view=detailv2&amp;idpp=genimg">Generated With AI</a> on <a href="https://www.bing.com/images/create?FORM=GENILP">Bing</a></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#the-problem-at-hand>The problem at hand</a></li><li><a href=#automating-profile-generation>Automating profile generation</a></li><li><a href=#automating-profile-verification>Automating profile verification</a></li></ul></nav></div></details></div><div class=post-content><p>Baseline profile allows you to pre-package a list of classes and methods with APK that are required during launch or in the critical user journey (Core flow of your app). Before the baseline profile, this list either had to be generated on the device by analyzing a few app launches or sourced from Play Store if other devices already figured out this list and uploaded it to Play Store. This list of classes and methods is then pre-compiled to machine code so that during app launch and critical user journey this code is ready to execute by CPU thereby making the entire flow faster.</p><p>Further reading of this blog requires context on the baseline profile and unfortunately, this is out of the scope for this blog. To start with I would recommend <a href="https://youtu.be/yJm5On5Gp4c?si=yqfq8QtnQ5MJbnDq">this</a> talk from the Android Dev Summit to get some context on the baseline profile and then continue here.</p><h2 id=the-problem-at-hand>The problem at hand<a hidden class=anchor aria-hidden=true href=#the-problem-at-hand>#</a></h2><p>Through this blog, I want to stress upon automation part of the baseline profile. As you make changes in the code you need to update the profile so that it can include new classes and methods required either during launch or during critical user journey.</p><p>Keeping the profile up to date is only half of the problem. You need to make sure the profile is working as expected. For that, you need to run macro-benchmark tests to verify profile is reducing launch time.</p><p>We will explore possible solutions to the above problems, so let’s get started without further ado!</p><h2 id=automating-profile-generation>Automating profile generation<a hidden class=anchor aria-hidden=true href=#automating-profile-generation>#</a></h2><p>With <a href=https://developer.android.com/topic/performance/baselineprofiles/configure-baselineprofiles>baseline profile gradle plugin</a> you can easily update profile as this plugin does the heavy lifting of building the required test APKs, running tests on the device, and copying the generated profile to the correct directory after test completes. Due to scope of this blog I won’t go into details about plugin setup. You would need a <a href=https://developer.android.com/topic/performance/baselineprofiles/create-baselineprofile>test module setup</a> and <a href=https://developer.android.com/topic/performance/baselineprofiles/configure-baselineprofiles>plugin setup</a> within the test module.</p><p>Assuming your plugin setup is correct, the CI setup is fairly simple. We will focus on GitHub action as our CI platform. Converting setup for other CI platforms shouldn’t be difficult. </p><p>Here is the workflow that will update the profile on every pull request. After a successful run, the workflow should update PR with the modified profile.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate Baseline Profile  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w> </span><span class=l>pull_request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build-benchmark-apks</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate baseline profile  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>macos-latest  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout-minutes</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v3  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Validate Gradle Wrapper  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>gradle/wrapper-validation-action@v1  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set up JDK 17  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-java@v3  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>distribution</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;zulu&#39;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>java-version</span><span class=p>:</span><span class=w> </span><span class=m>17</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install GMD image for baseline profile generation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w> </span><span class=l>| &#34;$ANDROID_HOME&#34;/cmdline-tools/latest/bin/sdkmanager &#34;system-images;android-33;aosp_atd;x86_64&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Accept Android licenses</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w> </span><span class=l>| &#34;$ANDROID_HOME&#34;/cmdline-tools/latest/bin/sdkmanager --licenses || true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate profile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>./gradlew :sample:generateBaselineProfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span>-<span class=l>Pandroid.testoptions.manageddevices.emulator.gpu=&#34;swiftshader_indirect&#34;</span><span class=w>
</span></span></span></code></pre></div><p>You can configure the baseline profile gradle plugin to generate profile through gradle managed device. The above workflow first installs a system image for gradle managed device. Then it accepts the license for the installed system image. Finally, it runs the generation part by executing <code>./gradlew :sample:generateBaselineProfile</code> command. Note <code>android.testoptions.manageddevices.emulator.gpu</code> test parameter we are passing. This is required to run gradle manged device on GitHub action running on macOS. Without this profile generation will fail throwing device setup error.</p><blockquote><p><em>If you can not use baseline profile gradle plugin for some reason (required AGP 8.0 and above) then this can be tricky as there would be an additional step required to pull the profile from the device and store it in the source directory. <a href=https://chrisbanes.me/>Chris Banes</a> wrote a <a href=https://twitter.com/chrisbanes/status/1597605571930513408>workflow</a> for this that you can use as a reference.</em></p></blockquote><h2 id=automating-profile-verification>Automating profile verification<a hidden class=anchor aria-hidden=true href=#automating-profile-verification>#</a></h2><p>When it comes to automating the verification of the profile, things are a little tricky. Profile verification requires running macro-benchmark tests on physical devices. This means you need to spin up a physical device to run verification and fetch benchmark results from the device. For the scope of this blog, we will focus on the Firebase test lab.</p><p>Running instrumented tests on the Firebase test lab is not challenging at all. Many of you are already doing this with your instrumented test setup on CI. Since macro benchmark tests are instrumented tests only, this should be fairly simple. What’s challenging though is to download benchmark JSON from the device and parse it on CI to analyze the result.</p><p>While contributing baseline profile CI setup on <a href=https://github.com/coil-kt/coil>COIL</a> (Image loading library) I came across the same challenge. I explored all possible solutions to automate the verification part and ultimately decided to write a Gradle plugin for this.</p><p><a href=https://github.com/sagar-viradiya/auto-benchmark/tree/main>Auto-Benchmark</a> (Sorry for the shameless plug 😅) is a gradle plugin to automate this step as this is a bit complicated and not straightforward. The only limitation here is this plugin only supports Firebase Test Lab (FTL). It uploads benchmark APK and App APK to FTL and once tests are complete it downloads the result JSON. This JSON is then parsed and analyzed to determine the impact of the profile. The impact here is the percentage of improvement between no compilation median startup and baseline profile median startup time. Let’s see how you can utilize this plugin.</p><p>Following is the plugin configuration you need in your app-level build.gradle file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>autoBenchmark</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  
</span></span><span class=line><span class=cl>    <span class=c1>// A relative file path from the root to app apk with baseline  profile
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>appApkFilePath</span><span class=p>.</span><span class=k>set</span><span class=p>(</span><span class=s2>&#34;/sample/build/outputs/apk/benchmark/sample-benchmark.apk&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// A relative file path from the root to benchmark apk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>benchmarkApkFilePath</span><span class=p>.</span><span class=k>set</span><span class=p>(</span><span class=s2>&#34;/benchmark/build/outputs/apk/benchmark/benchmark-benchmark.apk&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1>// A relative file path of service account JSON to authenticate Firebase Test Lab
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>serviceAccountJsonFilePath</span><span class=p>.</span><span class=k>set</span><span class=p>(</span><span class=s2>&#34;../../.config/gcloud/application_default_credentials.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Physical device configuration map to run benchmark
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>physicalDevices</span><span class=p>.</span><span class=k>set</span><span class=p>(</span><span class=n>mapOf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;model&#34;</span> <span class=n>to</span> <span class=s2>&#34;redfin&#34;</span><span class=p>,</span> <span class=s2>&#34;version&#34;</span> <span class=n>to</span> <span class=s2>&#34;30&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Tolerance percentage for improvement below which verification will fail
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>tolerancePercentage</span><span class=p>.</span><span class=k>set</span><span class=p>(</span><span class=m>10f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It takes three file paths. Two of them are relative paths to benchmark and app APKs. To authenticate Firebase Test Lab it requires your service account JSON file path. Next, it takes the device configuration on which you want to run your benchmark. In the above configuration, it uses Pixel 5 and API level 30. Lastly, It takes the <code>tolerancePercentage</code>. It is the percentage of improvement below which you want to fail your profile verification. So for example, if no compilation median startup is 233 ms and baseline profile median startup is 206 ms then startup time is improved by ~11%. If the provided tolerance percentage is 10 then the task will successfully complete.</p><p>To seed the tolerance percentage I would suggest running the benchmark on the initial profile locally many times (preferably more than 5 times) and taking the minimum percentage improvement between no compilation median startup and baseline profile median startup time.</p><blockquote><p><em>Seeding tolerance percentage like this is something I came up with. I know this is controversial as some of you might find this not a proper way to decide the baseline on your improvement. I would love to know your thoughts in case you have better suggestions on seeding tolerance percentage.</em></p></blockquote><p>With the above simple configuration, it is just a matter of issuing one gradle command <code>./gradlew :app:runBenchmarkAndVerifyProfile</code> to verify profile. For a detailed setup of this plugin, I would suggest checking the <a href=https://github.com/sagar-viradiya/auto-benchmark>README guide</a>.</p><p>Now that we have seen how plugin works let’s see how you can integrate the plugin in CI pipeline. Once again we will see how you can set up this on GitHub action but it should be simple to migrate this on your choice of CI.</p><p>In the above configuration, we saw we need a service account JSON file path. We need to set up that first before we run profile verification on CI. For that first store base64 encoded service account JSON file as the GitHub environment variable. Then later in the workflow, we will decode this file and put it at the root level of the CI machine file system. To encode service account JSON run the following command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>base64 -i “<span class=nv>$HOME</span>/.config/gcloud/application_default_credentials.json” <span class=p>|</span> pbcopy
</span></span></code></pre></div><p>Paste the encoded JSON file to the GitHub environment variable <code>GCLOUD_KEY</code>. To decode this and restore it in the file system of the CI machine, run the following bash commands as a workflow step.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>GCLOUD_DIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.config/gcloud/&#34;</span>  
</span></span><span class=line><span class=cl>mkdir -p <span class=s2>&#34;</span><span class=nv>$GCLOUD_DIR</span><span class=s2>&#34;</span>  
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>{ vars.GCLOUD_KEY </span><span class=si>}</span><span class=s2>}&#34;</span> <span class=p>|</span> base64 --decode &gt; <span class=s2>&#34;</span><span class=nv>$GCLOUD_DIR</span><span class=s2>/application_default_credentials.json&#34;</span>
</span></span></code></pre></div><p>The above commands decode the encoded service account JSON file from the GitHub environment variable at <code>$HOME/.config/gcloud/application_default_credentails.json</code></p><p>Now let’s see the entire workflow.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Verify Baseline Profile  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pull_request</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>release  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build-benchmark-apks</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build APKs and Run profile verification  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>macos-latest  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout-minutes</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v3  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Validate Gradle Wrapper  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>gradle/wrapper-validation-action@v1  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set up JDK 17  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-java@v3  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>distribution</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;zulu&#39;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>java-version</span><span class=p>:</span><span class=w> </span><span class=m>17</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build benchmark apk  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>./gradlew :benchmark:assembleBenchmark  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build app apk  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>./gradlew :sample:assembleBenchmark  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set up authentication  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>|  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=l>GCLOUD_DIR=&#34;$HOME/.config/gcloud/&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=l>mkdir -p &#34;$GCLOUD_DIR&#34;          </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=l>echo &#34;${{ vars.GCLOUD_KEY }}&#34; | base64 --decode &gt; &#34;$GCLOUD_DIR/application_default_credentials.json&#34;  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Verify baseline profile  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>./gradlew :sample:runBenchmarkAndVerifyProfile</span><span class=w>
</span></span></span></code></pre></div><p>In the above workflow, <code>Set up authentication</code> step is exactly doing what we saw above to restore the service account JSON file on the CI machine for the GitHub environment variable. After setting up credentials it runs the gradle command from plugin to verify profile. </p><p>This is all you need to detect regression in your baseline profile setup. You can check both workflows we saw in my <a href=https://github.com/sagar-viradiya/auto-benchmark/tree/release>repo</a> for reference. </p><p>One important thing that I want to highlight here is, this plugin is only to detect the performance dip below tolerance percentage and to fail fast on CI. You can go further and collect these benchmark run results to visualise on a dashboard. Monitoring macro-benchmark results on a dashboard would give you more insights into app performance over time. You can refer to <a href=https://github.com/android/performance-samples/tree/main/MacrobenchmarkSample/ftl>this</a> performance sample repo guide to know how it can be done through GCloud Monitoring. Also, <a href=https://p-y.wtf/>Py ⚔</a>published a <a href=https://blog.p-y.wtf/a-script-to-compare-two-macrobenchmarks-runs>script</a> that Square uses to compare two benchmark runs. Perhaps these are good starting points to build a dashboard around your macro-benchmark runs.</p><p>I hope this guide will help you to automate baseline profile on CI. I would appreciate your feedback on the plugin so please do try it out and let me know what can be improved.</p><p>Until next time! ☮️ ✌️</p><p>Thanks to <a href=https://shreyaspatil.dev/>Shreyas Patil</a> & <a href=https://medium.com/u/65fe4f480b1c>Ben Weiss</a> for proofreading this.</p><blockquote><p><em>This was originally posted on <a href=https://medium.com/p/fc11f8389c0b>Google Developer Expert Medium publication</a></em></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://sagarviradiya.dev/tags/performance/>Performance</a></li><li><a href=https://sagarviradiya.dev/tags/baselineprofile/>BaselineProfile</a></li><li><a href=https://sagarviradiya.dev/tags/gradle/>Gradle</a></li></ul><nav class=paginav><a class=next href=https://sagarviradiya.dev/posts/callback-ktx/><span class=title>Next »</span><br><span>Callback-ktx</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//disqus_viMbDBZglD.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2024 <a href=https://sagarviradiya.dev/>Sagar's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>