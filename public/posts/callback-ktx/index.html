<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Callback-ktx | Sagar's Blog</title>
<meta name=keywords content="Coroutines,Callback"><meta name=description content="Introduction to callback-ktx library"><meta name=author content><link rel=canonical href=https://sagarviradiya.dev/posts/callback-ktx/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.0346ff196149e1e8907ccd5dda7af0e63f0dea21feb0e2c4d5853b9e6554dca3.css integrity="sha256-A0b/GWFJ4eiQfM1d2nrw5j8N6iH+sOLE1YU7nmVU3KM=" rel="preload stylesheet" as=style><link rel=icon href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://sagarviradiya.dev/posts/callback-ktx/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://sagarviradiya.dev/posts/callback-ktx/"><meta property="og:site_name" content="Sagar's Blog"><meta property="og:title" content="Callback-ktx"><meta property="og:description" content="Introduction to callback-ktx library"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-05T00:00:00+00:00"><meta property="article:tag" content="Coroutines"><meta property="article:tag" content="Callback"><meta property="og:image" content="https://sagarviradiya.dev/images/header.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sagarviradiya.dev/images/header.jpg"><meta name=twitter:title content="Callback-ktx"><meta name=twitter:description content="Introduction to callback-ktx library"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sagarviradiya.dev/posts/"},{"@type":"ListItem","position":2,"name":"Callback-ktx","item":"https://sagarviradiya.dev/posts/callback-ktx/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Callback-ktx","name":"Callback-ktx","description":"Introduction to callback-ktx library","keywords":["Coroutines","Callback"],"articleBody":"This blog is about the library that came into existence after reading Chris Banes blog series on Suspending over Views. The intention behind this blog is to throw some light on this library and get feedback from the community. So enjoy this short one! :)\nAndroid ‚ù§Ô∏ès callback. All framework and jetpack libraries APIs uses it to notify events, but it becomes messy when you have nested callbacks. It‚Äôs difficult to understand and scale. Also, the chances of bugs are very high when you‚Äôre dealing with nested callbacks.\nThe good thing is we can easily avoid it through Kotlin‚Äôs coroutine APIs. callback-ktx is an attempt to wrap the potential framework and jetpack callback-based APIs into suspending extension functions. In case of multiple callbacks, it exposes Flow to observe all callbacks.\nIt would be kinda redundant if I explain all the benefits you will get by wrapping callbacks into suspending functions as Chris Banes blog series already covered them nicely. If you haven‚Äôt read it I would suggest reading it before continuing this one.\nIt is not difficult at all to wrap callback-based APIs into suspending function. What was challenging though was to go through all framework and jetpack APIs and figure out which API could be benefited. Let‚Äôs see what this library is capable of as of now.\nWhat is it? Currently, the library covers the following APIs from framework and jetpack.\nAnimation Location RecyclerView Sensor View Widget(TextView) Let‚Äôs see one example of observing location updates.\nTo get the last location all you need to do is to call awaitLastLocation which is an extension function over FusedLocationProviderClient\nviewLifecycleOwner.lifecycleScope.launch { val location = fusedLocationProviderClient.awaitLastLocation() // Suspend coroutine // Use location } To observe location update it exposes flow of location.\nviewLifecycleOwner.lifecycleScope.launch { fusedLocationProviderClient.locationFlow(locationRequest, lifecycleOwner).collect { location -\u003e // Consume location } } Note that extension takes lifecycle owner along with location request. This makes flow lifecycle aware so it won‚Äôt fire location updates while the app is in the background. You can visit the library on GitHub to see more examples.\nThere are two essential things while wrapping callback into suspending function to avoid potential memory leak and unwanted resource use by coroutines\nIf coroutine gets cancelled for some reason, the callback needs to be unregistered. If an async operation for which callback is expected gets cancelled, the coroutine needs to be terminated. The library takes care of both of these. Also, Callback extensions are divided across different modules based on the category they fall under. For example, all framework APIs would fall under the core module. Anything not related to the framework is in its separate module. So depending on the need user can depend on a specific maven artifact.\nWhat‚Äôs next? As I mentioned earlier, the big challenge while working on this library was to figure out all APIs that could be benefited. I would love to see contributions from the community in terms of filing issues for new extensions, bug fixes and optimisations. You can find repo here\nUntil next time üëãüèª\nThis was originally posted on Google Developer Expert Medium publication\n","wordCount":"514","inLanguage":"en","image":"https://sagarviradiya.dev/images/header.jpg","datePublished":"2021-10-05T00:00:00Z","dateModified":"2021-10-05T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://sagarviradiya.dev/posts/callback-ktx/"},"publisher":{"@type":"Organization","name":"Sagar's Blog","logo":{"@type":"ImageObject","url":"https://sagarviradiya.dev/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sagarviradiya.dev/ accesskey=h title="Sagar Viradiya (Alt + H)"><img src=https://sagarviradiya.dev/apple-touch-icon.png alt aria-label=logo height=35>Sagar Viradiya</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sagarviradiya.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://sagarviradiya.dev/talks/ title=Talks><span>Talks</span></a></li><li><a href=https://sagarviradiya.dev/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://sagarviradiya.dev/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sagarviradiya.dev/>Home</a>&nbsp;¬ª&nbsp;<a href=https://sagarviradiya.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Callback-ktx</h1><div class=post-meta><span title='2021-10-05 00:00:00 +0000 UTC'>October 5, 2021</span>&nbsp;¬∑&nbsp;3 min&nbsp;¬∑&nbsp;514 words</div></header><figure class=entry-cover><a href=https://sagarviradiya.dev/posts/callback-ktx/images/header.jpg target=_blank rel="noopener noreferrer"><img loading=eager srcset='https://sagarviradiya.dev/posts/callback-ktx/images/header_hu_1abe24737d247e7.jpg 360w,https://sagarviradiya.dev/posts/callback-ktx/images/header_hu_a21f15d7216a8dab.jpg 480w,https://sagarviradiya.dev/posts/callback-ktx/images/header_hu_60aaef537bac0a8d.jpg 720w,https://sagarviradiya.dev/posts/callback-ktx/images/header_hu_d23e943470ee3193.jpg 1080w,https://sagarviradiya.dev/posts/callback-ktx/images/header_hu_59b02e4f6c0e5e5.jpg 1500w,https://sagarviradiya.dev/posts/callback-ktx/images/header.jpg 4535w' src=https://sagarviradiya.dev/posts/callback-ktx/images/header.jpg sizes="(min-width: 768px) 720px, 100vw" width=4535 height=3023 alt="Photo by [CJ Dayrit](https://unsplash.com/@cjred?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash) on [Unsplash](https://unsplash.com/photos/woman-walking-through-downstairs-xX2aYSBsyKo?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash)"></a><figcaption>Photo by <a href="https://unsplash.com/@cjred?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">CJ Dayrit</a> on <a href="https://unsplash.com/photos/woman-walking-through-downstairs-xX2aYSBsyKo?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash">Unsplash</a></figcaption></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#what-is-it>What is it?</a></li><li><a href=#whats-next>What‚Äôs next?</a></li></ul></nav></div></details></div><div class=post-content><p>This blog is about the <a href=https://github.com/sagar-viradiya/callback-ktx><strong>library</strong></a> that came into existence after reading <a href=https://chrisbanes.me/>Chris Banes</a> blog series on <a href=https://chris.banes.dev/suspending-views/>Suspending over Views</a>. The intention behind this blog is to throw some light on this library and get feedback from the community. So enjoy this short one! :)</p><p>Android ‚ù§Ô∏ès callback. All framework and jetpack libraries APIs uses it to notify events, but it becomes messy when you have nested callbacks. It‚Äôs difficult to understand and scale. Also, the chances of bugs are very high when you‚Äôre dealing with nested callbacks.</p><p>The good thing is we can easily avoid it through Kotlin‚Äôs coroutine APIs. <a href=https://github.com/sagar-viradiya/callback-ktx>callback-ktx</a> is an attempt to wrap the potential framework and jetpack callback-based APIs into suspending extension functions. In case of multiple callbacks, it exposes <code>Flow</code> to observe all callbacks.</p><p>It would be kinda redundant if I explain all the benefits you will get by wrapping callbacks into suspending functions as Chris Banes blog series already covered them nicely. If you haven‚Äôt read it I would suggest reading it before continuing this one.</p><p>It is not difficult at all to wrap callback-based APIs into suspending function. What was challenging though was to go through all framework and jetpack APIs and figure out which API could be benefited. Let‚Äôs see what this library is capable of as of now.</p><h2 id=what-is-it>What is it?<a hidden class=anchor aria-hidden=true href=#what-is-it>#</a></h2><p>Currently, the library covers the following APIs from framework and jetpack.</p><ul><li>Animation</li><li>Location</li><li>RecyclerView</li><li>Sensor</li><li>View</li><li>Widget(TextView)</li></ul><p>Let‚Äôs see one example of observing location updates.</p><p>To get the last location all you need to do is to call awaitLastLocation which is an extension function over <a href=https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient><code>FusedLocationProviderClient</code></a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Kotlin data-lang=Kotlin><span class=line><span class=cl><span class=n>viewLifecycleOwner</span><span class=p>.</span><span class=n>lifecycleScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=py>location</span> <span class=p>=</span> <span class=n>fusedLocationProviderClient</span><span class=p>.</span><span class=n>awaitLastLocation</span><span class=p>()</span> <span class=c1>// Suspend coroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Use location
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>To observe location update it exposes flow of location.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Kotlin data-lang=Kotlin><span class=line><span class=cl><span class=n>viewLifecycleOwner</span><span class=p>.</span><span class=n>lifecycleScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fusedLocationProviderClient</span><span class=p>.</span><span class=n>locationFlow</span><span class=p>(</span><span class=n>locationRequest</span><span class=p>,</span> <span class=n>lifecycleOwner</span><span class=p>).</span><span class=n>collect</span> <span class=p>{</span> <span class=n>location</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Consume location
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Note that extension takes lifecycle owner along with location request. This makes flow lifecycle aware so it won‚Äôt fire location updates while the app is in the background. You can visit the <a href=https://github.com/sagar-viradiya/callback-ktx>library</a> on GitHub to see more examples.</p><p>There are two essential things while wrapping callback into suspending function to avoid potential memory leak and unwanted resource use by coroutines</p><ol><li>If coroutine gets cancelled for some reason, the callback needs to be unregistered.</li><li>If an async operation for which callback is expected gets cancelled, the coroutine needs to be terminated.</li></ol><p>The library takes care of both of these. Also, Callback extensions are divided across different modules based on the category they fall under. For example, all framework APIs would fall under the core module. Anything not related to the framework is in its separate module. So depending on the need user can depend on a specific maven artifact.</p><h2 id=whats-next>What‚Äôs next?<a hidden class=anchor aria-hidden=true href=#whats-next>#</a></h2><p>As I mentioned earlier, the big challenge while working on this library was to figure out all APIs that could be benefited. I would love to see contributions from the community in terms of filing issues for new extensions, bug fixes and optimisations. You can find repo <a href="https://github.com/sagar-viradiya/callback-ktx?source=post_page-----64f57b9fc6cc--------------------------------">here</a></p><p>Until next time üëãüèª</p><blockquote><p><em>This was originally posted on <a href=https://medium.com/google-developer-experts/callback-ktx-64f57b9fc6cc>Google Developer Expert Medium publication</a></em></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://sagarviradiya.dev/tags/coroutines/>Coroutines</a></li><li><a href=https://sagarviradiya.dev/tags/callback/>Callback</a></li></ul><nav class=paginav><a class=prev href=https://sagarviradiya.dev/posts/automating-baseline-profile/><span class=title>¬´ Prev</span><br><span>Automating Baseline Profile end-to-end on CI</span>
</a><a class=next href=https://sagarviradiya.dev/posts/modern-app-distribution-part-02/><span class=title>Next ¬ª</span><br><span>Modern Android app distribution with GitHub Actions Part ‚Äî II</span></a></nav></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//sagarviradiya-dev.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://sagarviradiya.dev/>Sagar's Blog</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>